<!DOCTYPE html>

<div>

    <div class="page-header ">
        <h4 class="page-title" id="myFilesTitle"> </h4>
    </div>
    <div class="row my-3 px-3 justify-content-start">
        <button class="btn btn-dark text-white" data-toggle="modal" data-target="#encryptFileModal" id="encryptFile">
            <img src="plugins/images/encrypt.png" width="20"><span id="encryptMainBtn"> Encrypt File</span>
        </button>

        <button type="button" data-toggle="modal" data-target="#signFilesModal"
            class="btn btn-secondary text-white mx-3" id="signFile">
            <i class="fas fa-file-signature"></i> <span id="signMainBtn">Sign File</span>
        </button>
    </div>
    <table id="myfiles" class="table table-striped" style="width:100%">
        <thead>
            <tr id="myfilesHeader">
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            


        </tbody>

    </table>
</div>


<!-- Modals -->
<!--Sign-->
<div class="modal fade" id="signFilesModal" tabindex="-1" role="dialog" aria-labelledby="signFiles" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-info" id="signFiles">Sign a File</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="fileDesc">
                    <label class="col-form-label w-100" id="describLable">وصف الملف</label class="col-form-label">
                    <textarea id="describe" class="form-control"></textarea>
                    <label class="error d-none required">هذا الحقل الزامي</label>
                </div>
                <div id="loadingSign" class="d-none ">
                    <p class="w-100 text-center d-block confirmUserId">جاري التاكد من هوية المستخدم</p>
                    <p class="w-100 text-center d-block">
                        <i class="fas fa-spinner  text-info fa-spin fa-3x"></i>
                    </p>
                </div>
                <div id="userConform" class="d-none">
                    <p class="w-100 text-center d-block confirmUserDone">تم التأكد من هوية المستخدم</p>
                    <p class="w-100 text-center d-block">
                        <i class="far fa-check-circle text-info fa-3x"></i>
                    </p>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-around">
                <button type="button" class="btn btn-secondary" id="signFileBtn">توقيع الملف</button>
            </div>
        </div>
    </div>
</div>

<!--Decrypt-->
<div class="modal fade" id="decryptFileModal" tabindex="-1" role="dialog" aria-labelledby="decryptFiles"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-info" id="decryptFiles">Decrypt a File</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="loadingSignDecrypt">
                    <p class="w-100 text-center d-block confirmUserId">جاري من هوية المستخدم</p>
                    <p class="w-100 text-center d-block">
                        <i class="fas fa-spinner  text-info fa-spin fa-3x"></i>
                    </p>
                </div>
                <div id="userConformDecrypt" class="d-none">
                    <p class="w-100 text-center d-block confirmUserDone">تم التأكد من المستخدم</p>
                    <p class="w-100 text-center d-block">
                        <i class="far fa-check-circle text-info fa-3x"></i>
                    </p>
                </div>
            </div>

        </div>
    </div>
</div>
<!--Encrypt-->
<div class="modal fade" id="encryptFileModal" tabindex="-1" role="dialog" aria-labelledby="encryptFile"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-info" id="encryptFileTitle"> a File</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formEncrypt" novalidate>
                    <div id="fileDescEncrypt">


                        <div class="form-group">
                            <label class="col-form-label w-100" id="emailLable">وصف الملف</label>
                            <input id="emailEncrypt" name="emailEncrypt" class="form-control" type="text" required>
                            <small class="d-block" id="manyEmails">يمكن اضافة أكثر من بريد بفاصلة ;</small>
                            <label class="error2 d-none">This field must containes Emails</label>

                        </div>
                        <div class="form-group">
                            <label class="col-form-label w-100" id="describLableEnc">وصف الملف</label
                                class="col-form-label">
                            <textarea id="EncryptDescribe" name="EncryptDescribe" class="form-control"
                                required></textarea>

                        </div>

                        <div class="modal-footer d-flex justify-content-around">
                            <input type="submit" class="btn btn-secondary" id="encryptFileBtn" value="تشفير الملف">
                        </div>
                    </div>

                </form>
            </div>
            <div id="loadingSignEncry" class="d-none ">
                <p class="w-100 text-center d-block" id="confirmSentData">جاري التاكد من البيانات المرسلة</p>
                <p class="w-100 text-center d-block">
                    <i class="fas fa-spinner  text-info fa-spin fa-3x"></i>
                </p>
            </div>
            <div id="userConformEncry" class="d-none">
                <p class="w-100 text-center d-block" id="confirmSentDataDone">تم التأكد من البيانات المرسلة</p>
                <p class="w-100 text-center d-block">
                    <i class="far fa-check-circle text-info fa-3x"></i>
                </p>
            </div>
            <div id="openSystem" class="d-none ">
                <p class="w-100 text-center d-block" id="encrypting">جاري تشفير الملف</p>
                <p class="w-100 text-center d-block">
                    <i class="fas fa-spinner  text-info fa-spin fa-3x"></i>
                </p>
            </div>
            <div id="encyends" class="d-none ">
                <p class="w-100 text-center d-block" id="encryptingDone">تم تشفير الملف</p>
                <p class="w-100 text-center d-block">
                    <img src="plugins/images/300-512.png" width="50px" />
                </p>
            </div>
        </div>
    </div>
</div>
</div>

<div class="modal fade" id="forwardFileModal" tabindex="-1" role="dialog" aria-labelledby="forwardFile"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-info" > Forward File </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formForward">
                    <div id="fileDescEncrypt">
                            <input id="fileIdforw" name="fileIdforw" class="form-control" type="text" hidden>

                        <div class="form-group">
                            <label class="col-form-label w-100" id="emailLable">Email</label>
                            <input id="emailForward" name="emailForward" class="form-control" type="email" required>
                            <label class="error2 d-none">This field must containes Emails</label>

                        </div>
                        <div class="form-group">
                            <label class="col-form-label w-100" >Notes </label>
                            <textarea id="forwardNotes" name="forwardNotes" class="form-control" ></textarea>

                        </div>

                        <div class="modal-footer d-flex justify-content-around">
                            <input type="submit" class="btn btn-secondary" id="forwardFileBtn" value="Forward File">
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Confirm delete</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form>
                <div class="form-group">
                  <input type="text" hidden id="idUserForDelete" />
                </div>
                <div class="form-group d-flex justify-content-center">
                    <span>Are you sure you want to delete this file ?</span>
                </div>
              </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelBtn" data-dismiss="modal">cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
          </div>
        </div>
      </div>


<!--ends Modal -->
<script src="plugins/js/jquery.validate.min.js"></script>
<!-- <script id="arMessages" src="plugins/ar/messages_ar.min.js"></script> -->
<script>

    $("#formForward").validate()
        readData();
    var filesTable = [];

    fetch("fakeData/myfiles.json")
        .then(res => res.json())
        .then(data => filesTable = data)
        .then(filesTable=>  {
            filesTable.map(row => {
                var crDate = new Date(row.createdOnTimeInMilliSecond).toString();
                var datArr = crDate.split(" ");
                datArr.length = 5;
                row.createdOnTimeInMilliSecond = datArr[0] + " " + datArr[1] + " " + datArr[2] + " " + datArr[3] + " " +datArr[4] + " " })


            filesTable.map(row=>{
            if(row.attachmentType === "SIGNED"){
                row.actions =
                '<a href="'+ row.path +'" target="_blank" style="font-size:1.5em"><i class="fas fa-file-download text-success"></i></a>\n\
                <i class="fas fa-share pt-2 text-info deleteUser " onclick="sendIdForward(' + row.id + ')" data-toggle="modal" data-target="#forwardFileModal" data-whatever="' + row.id + '"></i>\n\
                <i class="fas fa-trash-alt pt-2 text-danger deleteUser" onclick="sendIdDelete(' + row.id + ')" data-toggle="modal" data-target="#deleteModal" data-whatever="' + row.id + '"></i>\n\
                '
            } else {
                row.actions =
                ' <img src="plugins/images/300-512.png" width="30" class="mx-3" onclick="decryptFn('+row.id+')" class="decrypt" data-toggle="modal" data-target="#decryptFileModal" /> \n\
                <i class="fas fa-trash-alt pt-2 text-danger deleteUser" onclick="sendIdDelete(' + row.id + ')" data-toggle="modal" data-target="#deleteModal" data-whatever="' + row.id + '"></i>\n\
                '
            }
            }
            )

            if ($("html").attr("lang") === "en") {
                
                $('#myfiles').DataTable({
                    data: filesTable,
                    columns: [
                        { data: "fileName" },
                        { data: "attachmentType" },
                        { data: "status" },
                        { data: "createdOnTimeInMilliSecond" },
                        { data: "actions" },
                    ],
                });
            } else {
                
                $('#myfiles').DataTable(
                    {
                        "data": filesTable,
                        "columns": [
                            { data: "fileName" },
                            { data: "attachmentType" },
                            { data: "status" },
                            { data: "createdOnTimeInMilliSecond" },
                            { data: "actions" },
                        ],
                        language: {
                            "url": "plugins/json/arDataTable.json"
                        }
                    }
                );
            }


        })


        function decryptFn (id) {
        ///sending data for modal
        console.log(id)
        setTimeout(function () {
            $("#loadingSignDecrypt").addClass("d-none");
            $("#userConformDecrypt").removeClass("d-none");
            console.log("token")
            setTimeout(function () {
                $(".close").click()
                $("#loadingSignDecrypt").removeClass("d-none")
                $("#userConformDecrypt").addClass("d-none");
            }, 1000)
        }, 1000)
    }

    // $(".decrypt").click(function () {
    //     ///sending data for modal
    //     setTimeout(function () {
    //         $("#loadingSignDecrypt").addClass("d-none");
    //         $("#userConformDecrypt").removeClass("d-none");
    //         console.log("token")
    //         setTimeout(function () {
    //             $(".close").click()
    //             $("#loadingSignDecrypt").removeClass("d-none")
    //             $("#userConformDecrypt").addClass("d-none");
    //         }, 10)
    //     }, 1000)
    // })

    newFiles = 0
    $("#signFileBtn").click(function (e) {
        if ($("#describe").val() == "") {
            $("#describe").siblings("label.error").removeClass("d-none")
            return false;
        }
        let filedetails = $("#describe").val();
        console.log(filedetails)
        $("#fileDesc").css("display", "none");
        $("#loadingSign").removeClass("d-none")
        $("#signFileBtn").attr("disabled", true);
        //then after response
        setTimeout(function () {
            $("#loadingSign").addClass("d-none");
            $("#userConform").removeClass("d-none");
            console.log("token")
            setTimeout(function () {
                $(".close").click()

                $("#fileDesc").css("display", "block");
                $("#fileDesc textarea").val("")
                $("#loadingSign").addClass("d-none")
                $("#userConform").addClass("d-none");
                $("#signFileBtn").removeAttr("disabled");
            }, 1000)
        }, 1000)
    })

    $("#formEncrypt").validate();
    $("#formEncrypt").submit(function (e) {
        e.preventDefault();
        let emailsValid = $("#emailEncrypt").val()
        if (emailsValid.indexOf("@") < 0) {
            $("#emailEncrypt").siblings("label.error2").removeClass("d-none")
            return false
        }
        $("#emailEncrypt").siblings("label.error2").addClass("d-none")
        let emailsArr = emailsValid.split(";")
        let fileDescrip = $("#EncryptDescribe").val();
        console.log(emailsArr);
        console.log(fileDescrip);
        $("#fileDescEncrypt").addClass("d-none");
        $("#loadingSignEncry").removeClass("d-none");

        setTimeout(function () {
            $("#loadingSignEncry").addClass("d-none");
            $("#userConformEncry").removeClass("d-none")
            console.log("taken Recived");
            setTimeout(function () {
                $("#userConformEncry").addClass("d-none")
                $("#openSystem").removeClass("d-none");
                console.log("open system and send taken");
                setTimeout(function () {
                    $("#openSystem").addClass("d-none")
                    $("#encyends").removeClass("d-none");
                    console.log("open system and send taken");
                    setTimeout(function () {
                        $(".close").click();
                        $("#fileDescEncrypt").removeClass("d-none");
                        $("#encyends").addClass("d-none");
                    }, 1000)
                }, 1000);
            }, 1000);
        }, 1000)
    })


    function sendIdDelete(id) {
        $("#idUserForDelete").val(id)
    }

    function sendIdForward(id){
        $("#fileIdforw").val(id)
    }

///========================== Function to delete the file ========================
    $("#confirmDelete").click(function () {
        var userIdDeleted = $("#idUserForDelete").val()
        $.ajax({
            url: "",
            type: "DELETE",
            dataType: 'json',
            success: function (result) {
                var status = result.status;
                $('#deleteModal').removeClass('show');
                $('.modal-backdrop.fade.show').removeClass('show')
                setTimeout(function(){
                    showMessage(status,result.message)
                },100)
                
            }, error: function (result) {
                var status = result.status;
  
                $('#deleteModal').removeClass('show');
                $('.modal-backdrop.fade.show').removeClass('show')
                setTimeout(function(){
                if (status == 404) {
                    showMessage(false, "تعذر الوصول للموقع")
                }
            },100)
            }
        });
    })


//========================== Function to forward the file ========================
    $("#forwardFileBtn").click(function(){
        let dataForward = {
            fileId : $("#fileIdforw").val(),
            email: $("#emailForward").val(),
            notes: $("#forwardNotes").val(),
        }

        $.ajax({
            url: "",
            type: "POST",
            dataType: 'json',
            success: function (result) {
                var status = result.status;
                $('#forwardFileModal').removeClass('show');
                $('.modal-backdrop.fade.show').removeClass('show').addClass("d-none")
                setTimeout(function(){
                    showMessage(status,result.message)
                },100)
                
            }, error: function (result) {
                var status = result.status;
  
                $('#deleteModal').removeClass('show');
                $('.modal-backdrop.fade.show').removeClass('show')
                setTimeout(function(){
                if (status == 404) {
                    showMessage(false, "تعذر الوصول للموقع")
                }
            },100)
            }
        });


    })

</script>

</html>